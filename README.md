# Self-Driving-Go-Kart-Racer

## Introduction
An AI image-based agent is designed in order to win a 2 vs 2 game of ice hockey against a team of AI agents in SuperTuxKart. We explored 3 different data collections approaches, 2 different models and 2 different controller designs. The final image-based agent used a convolutional network along with a hand-designed controller to play in the tournament.

https://user-images.githubusercontent.com/89999225/149994479-c9a491d7-929d-409d-b207-310617295b99.mp4

## Data collection 
To collect training data, we modified runner.py and ran AI vs AI tournaments with random starting locations for the puck, recording 8000 frames per tournament. We recorded images from all 4 players. In aggregate, our dataset contained 32000 images and 32000 CSV files. Each CSV file contained:
1. X, Y puck location coordinates. These were extracted from the soccer state and then transformed using the to image function and the kart’s camera projection and view matrices.
2. Puck size. This was done by bit-shifting the instance property of the psytk.RenderData by 24 and summing up the elements that equal to 8. The resulting number represented the amount the pixels that correspond to the puck.
3. Puck visibility flag. This was calculated in a similar manner as described above for the size, except we produced a flag for absence (0) or presence (1) of the puck instead of the amount of pixels that correspond to it.

## Model Training
We trained a Convolutional Encoder-Decoder network with skip connections. Each encoder block contained a conv block, which contained 2 x [Conv2d - BatchNorm2d - ReLU] sequences. Each decoder block contained a conv block and ConvTranspose2d to perform image upsampling. We used the spatial argmax function on the decoder output to classify the puck location.
1. Location and Size. At first, we predicted the location and the size of the puck in a [0, 1] range. We wanted to make use of size in order to calculate the kart to puck distance, as a larger size would indicate a smaller distance. A size of 0 would indicate the absence of the puck. While this approach worked fairly well as a distance metric, the model would sometimes produce a false positive regarding the presence of the puck, i.e. 0.1 instead of 0. Therefore, we discarded this approach.
2. Location and Visibility. Instead, we predicted the location and a visibility flag for the puck. The visibility flag of presence (1) or absence (0) ended up being very accurate and reliable so we chose this approach. Furthermore, during training, we made use of several methods to make our model more robust. First, we used a weighted loss which combined the MSE loss (puck location) and the BCE loss (puck visibility) with appropriate weights. Second, we made sure to only calculate MSE loss when the puck is present, as we do not want to ”punish” the model for not detecting something that is not in the image. Finally, we also performed techniques such as data augmentation, learning rate scheduling and early stopping.

## Controller Design
Two approaches have been investigated as described below:
* Approach 1. This controller at first assigns roles to the two karts. The defender kart will remain near the home net and block any incoming attacks for the first 100 timesteps of the game and for 100 timesteps after each goal. Then it will join the attack and act the same way as the other kart, the striker, which will aim for the center of the puck. When the striker gains control of the puck, it will act based on one of the following scenarios. First, if the striker kart is a midfielder, it will attempt to steer the ball straight to target net. Second, if the striker kart is a winger, it will attempt to push the puck to the wall and slide it along the wall to the target net. Finally, in case the puck is not detected, the kart will move to the last detected puck location. 
* Approach 2. In this approach, while the kart is chasing the puck, the controller detects whether the kart is facing the target net. If not, the kart will turn around and push the puck towards the target net. We tried to make the kart turn in one direction until the puck was placed at the desired angle. We implemented a more sophisticated threepoint turning strategy so the puck turns quickly and locally. This technique has two advantages: first it allows the kart to avoid wide turns and second it retains the direction and rotation towards the area of interest.
* Optimization. Approach 2 was selected for further optimization as it was more robust to environment randomness. To improve scoring, we further optimized approach 2 to improve the following four aspects: 
  1. Aiming the target net: To push the puck into the net instead of straightly moving forward, we first designed the kart to push the center of the puck to make it move towards the net. However our experiments show that pushing the center, even with adding offsets, doesn’t change the moving direction of the puck significantly. We eventually made the aim-point of the kart sweep between the center of the puck and the symmetrical opposite direction to the target net to achieve a better aiming.
  2. Missing puck behavior: When the kart lost sight of puck, we originally designed the kart to move in the direction of the last known puck location. This method was effective when the puck is close, else, the kart tends to stay in the  same region. We eventually designed to reverse the kart to  its home net location if the puck could not be found after a few steps of searching. This not only expands the search area, but also makes our defenses stronger.
  3. Clashes between karts of the same team: We noticed that the karts of the same team would occasionally run into each other and one would block the other from scoring. To prevent this, we tracked if a kart was in contact with the puck (based on kart to puck distance), and if so, the other kart would slow down to avoid a clash.  
 ### Team Members: Mengxi Luo, Michail Mersinias, Parin Shah, Rohan Desai

